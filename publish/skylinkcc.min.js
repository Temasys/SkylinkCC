/*! skylinkcc - v0.4.0 - 2015-03-23 */
(function(){function SkylinkCC(){Skylink||log.error("Skylink is not loaded. Please load Skylink first before SkylinkCC.")}SkylinkCC.prototype=new Skylink,this.SkylinkCC=SkylinkCC,SkylinkCC.prototype.VERSION="0.4.0",SkylinkCC.prototype._inLobby=!1,SkylinkCC.prototype._defaultLobbyRoom="MAIN",SkylinkCC.prototype._lobbyRoom=!1,SkylinkCC.prototype.CALL_READY_STATE={LOBBY:1,REQUEST_CALL:2,ACCEPTED_CALL:3,START_CALL:4,REJECTED_CALL:-1},SkylinkCC.prototype._userCall=null,SkylinkCC.prototype.PEER_TYPE={CLIENT:"client",AGENT:"agent"},SkylinkCC.prototype.connect=function(lobbyRoom,userData,peerType){var self=this,checkReadyState=setInterval(function(){self._readyState===self.READY_STATE_CHANGE.COMPLETED&&self._user&&(clearInterval(checkReadyState),self._userCall={status:self.CALL_READY_STATE.LOBBY,peerType:peerType||self.PEER_TYPE.CLIENT},self._lobbyRoom=lobbyRoom||self._defaultLobbyRoom,self.joinRoom(self._lobbyRoom,{userData:userData,audio:!1,video:!1}))})},Skylink.prototype.getPeerInfo=function(peerId){return peerId&&peerId!==this._user.sid?this._peerInformations[peerId]||{}:(this._user=this._user||{},this._userData=this._userData||"",this._mediaStreamsStatus=this._mediaStreamsStatus||{},this._streamSettings=this._streamSettings||{},{userData:this._userData,settings:this._streamSettings,mediaStatus:this._mediaStreamsStatus,agent:{name:window.webrtcDetectedBrowser,version:window.webrtcDetectedVersion},userCall:this._userCall,call:this._userCall})},SkylinkCC.prototype._inRoomHandler=function(message){var self=this;log.log(["Server",null,message.type,"User is now in the room and functionalities are now available. Config received:"],message.pc_config),self._room.connection.peerConfig=self._setIceServers(message.pc_config),self._inRoom=!0,self._user.sid=message.sid,self._userCall&&self._userCall.status===self.CALL_READY_STATE.LOBBY&&(self._inLobby=!0),self._trigger("peerJoined",self._user.sid,self.getPeerInfo(),!0),self._sendChannelMessage({type:self._SIG_MESSAGE_TYPE.ENTER,mid:self._user.sid,rid:self._room.id,agent:window.webrtcDetectedBrowser,version:window.webrtcDetectedVersion,userInfo:self.getPeerInfo()}),log.log("Sending enter"),self._trigger("handshakeProgress",self.HANDSHAKE_PROGRESS.ENTER,self._user.sid)},SkylinkCC.prototype._privateMessageHandler=function(message){var targetMid=message.mid;message.callStatus?this._callStatusHandler(targetMid,message,!0):(log.log([targetMid,null,message.type,"Received private message from peer:"],message.data),this._trigger("incomingMessage",{content:message.data,isPrivate:!0,targetPeerId:message.target,isDataChannel:!1,senderPeerId:targetMid},targetMid,this._peerInformations[targetMid],!1))},SkylinkCC.prototype._publicMessageHandler=function(message){var targetMid=message.mid;message.callStatus?this._callStatusHandler(targetMid,message,!1):(log.log([targetMid,null,message.type,"Received public message from peer:"],message.data),this._trigger("incomingMessage",{content:message.data,isPrivate:!1,targetPeerId:null,isDataChannel:!1,senderPeerId:targetMid},targetMid,this._peerInformations[targetMid],!1))},SkylinkCC.prototype._callStatusHandler=function(targetMid,message,isPrivate){var call=message.data,checkPrivate=call.status>=this.CALL_READY_STATE.REQUEST_CALL?call.targetPeerId===this._user.sid:!0;isPrivate&&checkPrivate?(this._peerInformations[targetMid].call=call,this._userCall.status=call.status,this._trigger("peerCallRequest",targetMid,this._peerInformations[targetMid],!1)):isPrivate?log.error([message.mid,"CallStatus",call.status,"Dropped request because targetPeerId does not match"],call):(this._peerInformations[message.sender].call=call,call.peerType===this.PEER_TYPE.AGENT&&this._trigger("peerCallRequest",targetMid,this._peerInformations[targetMid],!1))},SkylinkCC.prototype.startPeerEvent=function(userData,event){var self=this;for(var e in this._EVENTS)if(this._EVENTS[e]===event.name)return void log.error("You cannot call a Skyway event.");event.name?setTimeout(function(){self.setUserData(userData),self._trigger(event.name,event.params)},200):log.error("No event name is provided")},SkylinkCC.prototype._handleCall=function(peerId,options,callback){return this._user?this._userCall?this._userCall.peerType!==options.peerType?void log.error("Peer type is not "+options.peerType+'. Peer type is: "'+this._userCall.peerType):(this._userCall.status=options.status||this._userCall.status,this._userCall.targetPeerId=options.targetPeerId||this._userCall.targetPeerId,this._userCall.targetRoom=options.targetRoom||this._userCall.targetRoom||null,this._sendChannelMessage({cid:this._key,mid:this._user.sid,rid:this._room.id,data:this._userCall,target:peerId,type:this._SIG_MESSAGE_TYPE.PRIVATE_MESSAGE,callStatus:!0}),this._trigger("peerCallRequest",this._user.sid,this.getPeerInfo(),!0),void(callback&&callback())):void log.error('"_userCall" object is not loaded yet. Check readyState.'):void log.error('"_user" object is not loaded yet. Check readyState.')},SkylinkCC.prototype.agentRequestCall=function(clientPeerId,room){this._handleCall(clientPeerId,{status:this.CALL_READY_STATE.REQUEST_CALL,targetPeerId:clientPeerId,targetRoom:room||clientPeerId,peerType:this.PEER_TYPE.AGENT})},SkylinkCC.prototype.acceptRequestCall=function(agentPeerId,accept){this._handleCall(agentPeerId,{status:accept?this.CALL_READY_STATE.ACCEPTED_CALL:this.CALL_READY_STATE.REJECTED_CALL,targetPeerId:agentPeerId,targetRoom:this._peerInformations[agentPeerId].call.targetRoom,peerType:this.PEER_TYPE.CLIENT})},SkylinkCC.prototype.startRequestCall=function(targetPeerId,callback){var peerInfo,self=this,doLeaveRoom=function(){self.leaveRoom(),self._inLobby=!1,callback(self.getPeerInfo(),peerInfo)};self._userCall.peerType===self.PEER_TYPE.AGENT?this._handleCall(targetPeerId,{status:self.CALL_READY_STATE.START_CALL,targetPeerId:targetPeerId,peerType:this.PEER_TYPE.AGENT},function(){peerInfo=self._peerInformations[targetPeerId],setTimeout(function(){doLeaveRoom()},3500)}):(peerInfo=self._peerInformations[targetPeerId],doLeaveRoom())},SkylinkCC.prototype._EVENTS.peerCallRequest=[],SkywayCC=SkylinkCC}).call(this);